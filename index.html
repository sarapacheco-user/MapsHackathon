<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Route Safety Navigator</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
      font-family: Arial, sans-serif;
    }
    header {
      background-color: #2c3e50;
      color: white;
      padding: 1rem;
      text-align: center;
    }
    .container {
      display: flex;
      flex: 1;
    }
    .sidebar {
      width: 300px;
      background-color: #f5f5f5;
      padding: 1rem;
      overflow-y: auto;
      border-right: 1px solid #ddd;
    }
    .map-container {
      flex: 1;
    }
    #map {
      height: 100%;
      width: 100%;
    }
    input, select, button {
      width: 100%;
      padding: 0.5rem;
      margin-top: 0.5rem;
      box-sizing: border-box;
    }
    button {
      background-color: #3498db;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background-color: #2980b9;
    }
    .route-option {
      border: 1px solid #ddd;
      padding: 0.5rem;
      margin-top: 0.5rem;
      border-radius: 5px;
      cursor: pointer;
    }
    .route-option:hover {
      background-color: #eee;
    }
    .selected-route {
      border: 2px solid #3498db;
      background-color: #e6f2fa;
    }
  </style>
</head>
<body>
  <header>
    <h1>Route Safety Navigator</h1>
  </header>
  <div class="container">
    <div class="sidebar">
      <label>Origin:</label>
      <input id="origin" placeholder="Enter starting point">
      <label>Destination:</label>
      <input id="destination" placeholder="Enter destination">
      <label>Travel Mode:</label>
      <select id="travel-mode">
        <option value="DRIVING">Driving</option>
        <option value="WALKING">Walking</option>
        <option value="BICYCLING">Bicycling</option>
      </select>
      <button onclick="findRoutes()">Find Safest Route</button>

      <div id="route-options"></div>
    </div>
    <div class="map-container">
      <div id="map"></div>
    </div>
  </div>

  <script>
    let map;
    let polyline = null;

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: -23.5505, lng: -46.6333 }, // SÃ£o Paulo default
        zoom: 12,
      });
    }

    async function geocodeAddress(address) {
      const response = await fetch(`http://localhost:5000/geocode?address=${encodeURIComponent(address)}`);
      const data = await response.json();
      if (!response.ok) throw new Error(data.error);
      return { lat: data.latitude, lng: data.longitude };
    }

    async function findRoutes() {
      const originInput = document.getElementById('origin').value;
      const destinationInput = document.getElementById('destination').value;
      const travelMode = document.getElementById('travel-mode').value;

      if (!originInput || !destinationInput) {
        alert('Please enter both origin and destination');
        return;
      }

      try {
        const origin = await geocodeAddress(originInput);
        const destination = await geocodeAddress(destinationInput);

        const response = await fetch('http://localhost:5000/safest-route', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            origin: origin,
            destination: destination,
            travel_mode: travelMode
          })
        });

        const data = await response.json();
        if (!response.ok) {
          alert(data.error || "Error fetching safest route");
          return;
        }

        drawPolyline(data.route.overview_polyline);
        showRouteInfo(data);

      } catch (error) {
        alert('Error: ' + error.message);
        console.error(error);
      }
    }

    function drawPolyline(encoded) {
      if (polyline) {
        polyline.setMap(null);
      }

      const path = google.maps.geometry.encoding.decodePath(encoded);

      polyline = new google.maps.Polyline({
        path: path,
        geodesic: true,
        strokeColor: '#3498db',
        strokeOpacity: 0.8,
        strokeWeight: 6,
      });

      polyline.setMap(map);

      const bounds = new google.maps.LatLngBounds();
      path.forEach(point => bounds.extend(point));
      map.fitBounds(bounds);
    }

    function showRouteInfo(data) {
      const route = data.route;
      const safety = data.safety_analysis;

      const routeOptionsDiv = document.getElementById('route-options');
      routeOptionsDiv.innerHTML = `
        <div class="route-option selected-route">
          <strong>${route.summary || "Safest Route"}</strong><br>
          Distance: ${route.distance.text}<br>
          Duration: ${route.duration.text}<br>
          <strong>Safety Score:</strong> ${safety.score}<br>
          <strong>Primary Risks:</strong> ${safety.primary_risks.length > 0 ? safety.primary_risks.join(', ') : 'None'}
        </div>
      `;
    }
  </script>

  
  <script 
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC_dtv1k_0leuqeAOcMItWCzNzS62cq63k&libraries=geometry&callback=initMap"
    async defer>
  </script>
</body>
</html>
